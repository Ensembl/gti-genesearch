#!/bin/bash --

JAVA_HOME={{ java_dir }}
export PATH=$JAVA_HOME/bin:$PATH
export ES_HEAP_SIZE={{ es_heap }}
cd {{ es_dir }}
PID_FILE={{ es_pid_file }}

function stop_es {
  if [ -e "$PID_FILE" ]; then
    pid=$(cat $PID_FILE)
    echo "Stopping ES (pid $pid)" 1>&2
    kill -SIGTERM $pid      
    timeout=60 
    while ps $pid >/dev/null; do
      echo "Waiting for web to stop"
      sleep 5
      ((timeout -= 5))    
      if [ "$timeout" -le "0" ]; then
        echo "Killing web"
        kill -9 $1
      fi
    done
    rm -f $PID_FILE
  else
    echo "ES not running" 1>&2
  fi  
}

function start_es {
    if [ -e "$PID_FILE" ]; then
	echo "ES still running (pid file $PID_FILE)" 1>&2
	exit 2
    fi
    nohup ./bin/elasticsearch -d -p $PID_FILE
}
action=$1
if [ "$action" == "start" ]; then
    start_es
elif [ "$action" == "stop" ]; then
    stop_es
elif [ "$action" == "restart" ]; then
    stop_es
    start_es
else
    echo "Usage: $0 start|stop|restart" 1>&2
    exit 1
fi
